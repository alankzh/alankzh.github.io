---
layout: post
title:  "谈谈并发(consistency)"
date:   2019-08-11 9:29
categories: 修养
tags: 编程 守则 Java C++
---
* content
{:toc}

谈到一致性(consistency)，能联想到的场景有以下:
<br/>
- Associated_1. 数据库事务，ACID中的一致性。
- Associated_2. 分布式系统的一致性。包括缓存、数据存储、消息队列。
- Associated_3. 多核CPU，缓存、内存一致性。

由于一致性在计算机行业内涉及的广泛，所以我很难给出一个涵盖不同场景的精确定义。
<br/><br/>
比较宽泛的定义是，一致性 ≈ 正确性 = 与期望一致。
<br/><br/>
正确，是相对于错误而言的。一个系统，是由状态和一些导致状态转移的操作组成的。
如果系统的状态与期望一致，那么人们认为这个系统是正确的。
<br/><br/>
不同场景有不同的期望，所以有不同的一致性。
<br/><br/>
## Q1: 电商超卖
<br/>
电商中，订单和库存的状态，操作产生的新状态，如何才能与与人们的期望是一致的呢？
<br/>
如果订单的状态先被改变为'下单'，若后续的库存状态改变失败，则导致超卖；
<br/>
如果库存状态先被改变为number - 1，若后续的下订单不成功，那么导致少卖。
<br/><br/>
两种情况都是不符合人们的期望的，不正确，产生了问题。对这个业务，我们期望获得一致性。
<br/><br/>
## ACID
如果订单和库存都是单个服务、单个数据库来保障的，那么可以依赖具有ACID特性的数据库来满足业务一致性。例如DB2、MySQL、Oracle、PostgreSQL等。
<br/>

一个ACID是一个事物单元，它需要满足：
- A: Atomicity，原子性
- C: Consistency，一致性
- I: Isolation，隔离性
- D: Durability，持久性

<br/>
事物(T1)：用户购买2本《C++ Primer》，同时扣除库存容量2。
<br/><br/>
事物(T2)：另一用户购买1一本《C++ primer》，扣除库存容量1。
<br/><br/>
原子性表明数据库会明确的从一个状态到另一个状态，不会有中间状态。不管T1期间发生什么，不会发生用户有了一个两本书的订单而库存未被扣除的情况。
<br/><br/>
隔离性确保如果T1和T2同时发生，那么库存将被扣除3，而不是T1和T2之间存在抹除。
<br/><br/>

持久性确保如果T1刚刚提交，数据库崩溃，T1不会消失。
<br/><br/>

一致性与原子性和隔离性相关。订单和库存没有生成或灭失。
<br/><br/>

这里的一致性是数据库自身事物的一致性，对于Q1，业务上利用的是数据库提供的原子性和隔离性来达成服务方面的一致性。
<br/><br/>

## CAP

互联网项目大多数是大规模、高并发的，必须使用拆分的理念，对高并发的压力“分而治之，大而化小”。对于Q1，有时相关的表无法放到同一个数据库中，并且订单服务和库存服务可能是拆分的。
<br/><br/>
分布式系统的CAP理论包含了如下三个元素:
- C: Consistency,一致性。在分布式系统中的所有数据备份，在同一时刻具有同样的值，所有节点在同一时刻读取的数据都是最新的数据副本。
- A: Availability，可用性。完全的可用性是指在任何故障模型下，服务都会在有限的时间内处理完成并进行响应。
- P：Partition tolerance，分区容忍性。尽管网络上有部分消息丢失，但系统仍让可继续工作。

<br/>
CAP理论指出，任何分布式系统只可同时满足以上两点，无法三者兼顾。而分布式的服务化系统，都要满足分区容忍性，那么需要权衡的即为一致性和可用性。这里我将CAP理论提出的一致性称为强一致性。后续我们会看到为了可用性，我们会牺牲强一致性，只要求分布式系统满足弱一致性。

回顾下具有ACID的关系型数据库。它不具备分区容忍性，但是它具有强一致性和可用性。
<br/><br/>
不过数据库在一致性和可用性之间也存在着权衡。它一般定义四个隔离级别:
- Serializable
- Repeatable read
- Read committed
- Read uncommitted

不同的隔离级别具有不同层度的一致性、可用性。隔离级别越低，可用性越高。相应的，一致性也越弱。
参考文章: [Highly Available Transactions](http://www.vldb.org/pvldb/vol7/p181-bailis.pdf)

数据库为了提供可用性，不但提供了可选的隔离级别，内部也做了各种优化，有多种类型、多种粒度的锁。一些数据库还使用多版本控制的机制。两种各有利弊，一个悲观锁、一个乐观锁。关于多版本控制，可参见文章:
http://momjian.us/main/writings/pgsql/mvcc.pdf
<br/><br/>
既然数据库为了可用性做出了对一致性的牺牲。那么分布式系统一样可以对一致性进行牺牲。所需慎重考虑的是，这种牺牲是否在一定层度之内，即分布式系统没有满足强一致性，但也满足了一定层度的一致性。
<br/><br/>
## Consistency Model
为了不同的性能(可用性)




  